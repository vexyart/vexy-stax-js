# this_file: .code-review-checklist.md
# Code Review Checklist

## Overview

This checklist ensures consistent, thorough code reviews for Vexy Stax JS. Use this for all pull requests, whether from external contributors or internal development.

---

## Pre-Review (Automated Checks)

These run automatically via GitHub Actions CI (`.github/workflows/ci.yml`):

- [ ] ✅ **All tests passing** (223/223 unit tests)
- [ ] ✅ **Build succeeds** (1,143.27 kB baseline)
- [ ] ✅ **No security vulnerabilities** (npm audit --audit-level=high)
- [ ] ✅ **Package lock verified** (no uncommitted changes)
- [ ] ✅ **Node.js version correct** (18+ via .nvmrc)

**Status Check**: If any automated check fails, request fixes before manual review.

---

## Code Quality

### General Code Standards

- [ ] **Code follows project conventions**
  - 4-space indentation (per .editorconfig)
  - camelCase for functions/variables
  - PascalCase for classes
  - UPPERCASE_SNAKE_CASE for constants
  - LF line endings (enforced by .gitattributes)

- [ ] **No console.log calls** (except in help() function or RenderLoop debug)
  - Use logger utility: `createLogger(moduleName)`
  - Verify with: `grep -r "console\." src/ --exclude=main.js --exclude=RenderLoop.js`

- [ ] **No magic numbers**
  - All numeric constants defined in src/core/constants.js
  - Values properly documented with JSDoc

- [ ] **SPDX headers present**
  - All new source files have license header
  - Format: `// SPDX-License-Identifier: Apache-2.0`
  - Copyright: `// Copyright 2025 Adam Twardoch / VexyArt`

- [ ] **this_file comments present**
  - All new files have path tracking
  - Format: `// this_file: src/path/to/file.js`

### Code Complexity

- [ ] **Functions < 20 lines** (guideline, not strict rule)
- [ ] **Files < 200 lines** (except main.js - under active modularization)
- [ ] **Nesting depth < 3 levels**
- [ ] **No duplicate code** (DRY principle)

**Red Flags**:
- Functions >50 lines require justification
- Files >300 lines should be split
- Deeply nested conditionals (>3 levels)

---

## Documentation

### JSDoc Coverage

- [ ] **All exported functions have JSDoc**
  - @param with types and descriptions
  - @returns with type and description
  - @throws for error conditions
  - @example with usage examples

- [ ] **All exported constants have JSDoc**
  - @type annotation
  - @constant tag
  - @default value
  - Purpose description

- [ ] **Classes have comprehensive JSDoc**
  - Class-level description
  - Constructor documentation
  - Usage examples
  - Public method documentation

### Inline Comments

- [ ] **Complex logic explained**
  - Why, not what (code shows what)
  - Edge cases documented
  - Workarounds noted with reason

- [ ] **No TODO/FIXME comments** (use GitHub Issues instead)
- [ ] **No commented-out code** (use git history)

### README/Docs Updates

- [ ] **README.md updated** (if public API changes)
- [ ] **CHANGELOG.md entry added** (what changed, why)
- [ ] **API.md updated** (if window.vexyStax functions added/changed)
- [ ] **Test count updated** (if tests added, update README badge)

---

## Testing

### Test Coverage

- [ ] **New code has tests**
  - Unit tests for new functions
  - Edge cases tested (null, undefined, empty, extreme values)
  - Error conditions tested (TypeError, RangeError)

- [ ] **Coverage thresholds met**
  - Lines: ≥80%
  - Functions: ≥80%
  - Branches: ≥75%
  - Verify with: `npm run test:coverage:check`

- [ ] **Test names are descriptive**
  - Format: `{action} {condition} {expected_result}`
  - Example: `throws TypeError for non-numeric input`

### Test Quality

- [ ] **Tests are deterministic** (no flaky timing)
- [ ] **Tests are isolated** (no shared state)
- [ ] **Async tests have proper timeouts**
  - Use 2x-3x safety margins
  - Example: 50ms debounce → 100ms test timeout

- [ ] **Performance not regressed**
  - Test suite < 700ms (baseline: 627ms ±3ms)
  - Verify with: `npm run test:unit`

---

## Error Handling

### Error Messages

- [ ] **Include function/class name** in error messages
  - Format: `functionName: description of problem`
  - Example: `calculateLuminance: expected valid hex color, got "invalid"`

- [ ] **Use correct error types**
  - TypeError: type validation failures
  - RangeError: out-of-bounds values
  - Error: general errors

- [ ] **Error messages are actionable**
  - Include actual value received (if helpful)
  - Suggest valid input format
  - Provide context for debugging

### Error Handling Patterns

- [ ] **All errors logged** (via logger utility)
- [ ] **User-facing errors are friendly**
  - Use toast notifications for UI errors
  - Avoid technical jargon in messages

- [ ] **Resources cleaned up** on errors
  - Three.js objects disposed
  - Event listeners removed
  - Timers cleared

---

## Performance

### Bundle Size

- [ ] **Bundle size not increased significantly**
  - Baseline: 1,143.27 kB
  - Warning: >1,200 kB (+5%)
  - Critical: >1,300 kB (+13%)
  - Verify with: `npm run audit:size`

### Runtime Performance

- [ ] **No unnecessary re-renders**
- [ ] **Expensive operations debounced/throttled**
- [ ] **Large arrays/objects not copied unnecessarily**
- [ ] **Memory leaks prevented**
  - Event listeners cleaned up
  - Three.js objects disposed
  - Timers/intervals cleared

### Code Efficiency

- [ ] **No N+1 queries** (batch operations where possible)
- [ ] **Avoid blocking the main thread**
- [ ] **Use requestAnimationFrame** for animations

---

## Security

### Input Validation

- [ ] **All user inputs validated**
  - File type checking (validateImageFile)
  - File size limits (50MB reject, 10MB warning)
  - Numeric bounds (FOV: 15-120, zoom: 0.1-3.0)

- [ ] **No eval() or Function() constructor**
- [ ] **No innerHTML** (use textContent or DOM methods)
- [ ] **URL sanitization** (if accepting external URLs)

### Dependencies

- [ ] **No new dependencies added** (without justification)
  - Prefer existing solutions
  - Evaluate: stars, recent updates, license
  - Document in DEPENDENCIES.md

- [ ] **npm audit passes** (zero high/critical vulnerabilities)

---

## Git Hygiene

### Commit Quality

- [ ] **Commit message follows template** (.gitmessage)
  - Clear summary line (50 chars max)
  - Detailed description
  - Tasks completed list
  - Test results included

- [ ] **Atomic commits** (one logical change per commit)
- [ ] **No merge commits** (rebase instead)
- [ ] **No WIP commits** (squash before merging)

### Branch Naming

**Format**: `{type}/{short-description}`
- `feature/add-video-export`
- `bugfix/fix-memory-leak`
- `docs/update-api-reference`
- `test/add-integration-tests`

### PR Description

- [ ] **Clear title** (what was changed)
- [ ] **Why change was needed**
- [ ] **Testing performed**
- [ ] **Screenshots** (if UI changes)
- [ ] **Breaking changes noted** (if any)

---

## Three.js Specific

### Resource Management

- [ ] **Geometries disposed** (geometry.dispose())
- [ ] **Materials disposed** (material.dispose())
- [ ] **Textures disposed** (texture.dispose())
- [ ] **Scenes cleared** (scene.clear())

### WebGL Best Practices

- [ ] **Texture sizes are power-of-2** (for mipmaps)
- [ ] **Textures have proper format** (RGBAFormat, LinearFilter)
- [ ] **Shadow maps configured** (VSM, not PCF)
- [ ] **Camera far plane reasonable** (5000, not 100000)

### Three.js Patterns

- [ ] **Use object pooling** (for frequently created/destroyed objects)
- [ ] **Batch geometry updates** (updateMatrix once, not per vertex)
- [ ] **Use BufferGeometry** (not legacy Geometry)

---

## Checklist Summary

**Before Requesting Review**:
1. Run `npm test` - all 223 tests passing
2. Run `npm run build` - build succeeds
3. Run `npm audit` - zero vulnerabilities
4. Self-review with this checklist
5. Ensure commit messages follow template

**Reviewer Responsibilities**:
1. Check all automated CI checks passed
2. Review code quality (conventions, complexity)
3. Verify tests cover new code
4. Check documentation updated
5. Validate error handling
6. Approve or request changes with specific feedback

**Merge Criteria**:
- ✅ All CI checks passing
- ✅ At least 1 approval from maintainer
- ✅ All reviewer comments addressed
- ✅ Tests: 223/223 passing
- ✅ Coverage: ≥80/80/75%
- ✅ Build: ≤1,300 kB
- ✅ No security vulnerabilities

---

## Review Time Estimates

| PR Size | Lines Changed | Review Time |
|---------|---------------|-------------|
| **XS** | <10 | 5 minutes |
| **S** | 10-50 | 15 minutes |
| **M** | 50-200 | 30 minutes |
| **L** | 200-500 | 1 hour |
| **XL** | 500+ | 2+ hours |

**Guideline**: PRs >500 lines should be split into smaller, logical chunks.

---

## Common Issues

### ❌ Missing Tests
**Problem**: New function added without tests
**Fix**: Add unit tests in `tests/{category}_{module}.test.js`

### ❌ Flaky Tests
**Problem**: Tests pass locally but fail in CI
**Fix**: Increase timeout safety margins, check for timing dependencies

### ❌ Bundle Size Spike
**Problem**: Bundle grew from 1,143 kB → 1,250 kB
**Fix**: Check imported packages, tree-shaking, unnecessary dependencies

### ❌ Console.log Remaining
**Problem**: Debug console.log calls not removed
**Fix**: Migrate to logger utility, remove temporary debug calls

### ❌ Magic Numbers
**Problem**: Hardcoded values like `setTimeout(fn, 5000)`
**Fix**: Define constant in constants.js with descriptive name

---

## Resources

- **Testing Guide**: `.testing-guide.md`
- **Contributing Guide**: `CONTRIBUTING.md`
- **Error Message Guide**: `.error-message-guide.md`
- **Dependency Security**: `.dependency-security.md`
- **CI/CD Workflow**: `.cicd-workflow.md`

---

**Last Updated**: 2025-11-05 (Iteration 63)
**Maintained By**: Project maintainer
**Review This Checklist**: Quarterly (next: 2026-02-05)
