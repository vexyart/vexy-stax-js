# <!-- this_file: .filesize-tracking.md -->
# Bundle Size Tracking

## Purpose

Track bundle size growth across iterations to prevent bloat and identify size regressions. This document maintains a historical record of build artifacts and their sizes.

## Current Status (Iteration 61)

**Total Build Size**: 1,148.34 kB
- `index.html`: 1.24 kB (gzip: 0.58 kB)
- `index-Dlfyt3_3.css`: 3.83 kB (gzip: 1.30 kB)
- `index-Cup3QOvZ.js`: 1,143.27 kB (gzip: 291.51 kB) ‚ö†Ô∏è >500 kB warning

**Build Time**: 2.78s

## Size Regression Thresholds

| Threshold | Size | Action |
|-----------|------|--------|
| ‚ö†Ô∏è Warning | 1,200 kB | Investigate what caused growth |
| üö® Critical | 1,300 kB | Block release, require optimization |
| ‚úÖ Target | <1,150 kB | Ideal range (current baseline) |

**Gzip Threshold** (user download size):
- ‚ö†Ô∏è Warning: >320 kB gzipped
- üö® Critical: >350 kB gzipped
- ‚úÖ Current: 291.51 kB (good)

## Historical Data

| Iteration | Date | Total Size | JS Size | CSS Size | Change | Notes |
|-----------|------|------------|---------|----------|--------|-------|
| 61 | 2025-11-05 | 1,148.34 kB | 1,143.27 kB | 3.83 kB | baseline | File size tracking established |
| 26-60 | 2025-11-05 | 1,143.27 kB | 1,143.27 kB | ~4 kB | stable | 34 iterations with stable size |
| 0-25 | 2025-11-05 | 1,149 kB | ~1,145 kB | ~4 kB | +6 kB | Initial baseline |

**Trend**: Bundle size has been remarkably stable for 35+ iterations (26-61), varying by <1 kB despite adding:
- +113 tests (110 ‚Üí 223)
- Multiple new modules (RenderLoop, logging utilities)
- Extensive JSDoc documentation
- Additional constants and validation

This stability indicates good code efficiency and suggests Vite's tree-shaking is working effectively.

## Size by Dependency (Estimated)

Based on dependencies in package.json:

| Dependency | Estimated Size | Notes |
|------------|----------------|-------|
| **three** | ~580 kB | Core 3D engine (~51% of bundle) |
| **tweakpane** | ~100 kB | UI controls library |
| **@kitschpatrol/tweakpane-plugin-essentials** | ~30 kB | Tweakpane extras |
| **tweakpane-plugin-color-plus** | ~20 kB | Color picker plugin |
| **gsap** | ~45 kB | Animation library |
| **Application code** | ~370 kB | main.js + modules (~32% of bundle) |

**Total**: ~1,145 kB (matches actual bundle size)

## Size Breakdown by Module (Application Code)

| Module | Estimated Lines | Estimated Size | % of App Code |
|--------|----------------|----------------|---------------|
| main.js | 3,367 | ~250 kB | 68% |
| Managers (Scene/Lighting/Floor) | ~800 | ~60 kB | 16% |
| Core (constants, AppState, EventBus, RenderLoop, etc.) | ~600 | ~45 kB | 12% |
| Utils (helpers, logger) | ~300 | ~15 kB | 4% |

**Note**: main.js modularization (Phase 5) is expected to improve code organization without significantly changing bundle size due to tree-shaking.

## Monitoring Commands

### Get Current Build Size
```bash
npm run build 2>&1 | grep -E "(kB|built in)"
```

### Get Detailed Size Breakdown
```bash
npm run audit:size
# Outputs:
# docs/assets/*.css: sorted by size
# docs/assets/*.js: sorted by size
```

### Check for Size Regression
```bash
# Build and extract JS size
npm run build 2>&1 | grep "index.*\.js" | awk '{print $3}'

# Compare to baseline (1,143.27 kB)
# Warning if > 1,200 kB
# Critical if > 1,300 kB
```

### Analyze Bundle Composition
```bash
# Use Vite's rollup-plugin-visualizer (not currently installed)
# Or manually inspect build output with source maps
npm run build -- --sourcemap
```

## Size Optimization Strategies

### Already Implemented ‚úÖ
1. **Vite tree-shaking**: Removes unused code automatically
2. **ES modules**: Enables efficient dependency analysis
3. **Minification**: Built-in Vite minification
4. **Gzip compression**: 291.51 kB gzipped (75% reduction)
5. **`sideEffects: false`** in package.json: Enables aggressive tree-shaking

### Potential Future Optimizations
1. **Code splitting**: Split vendor libs from application code
2. **Dynamic imports**: Load Tweakpane/GSAP on-demand
3. **Three.js custom build**: Import only used features (requires manual configuration)
4. **Bundle analyzer**: Install rollup-plugin-visualizer for detailed analysis
5. **Compression**: Consider Brotli compression (better than gzip)

## Common Size Issues

### Unexpected Growth
**Symptoms**: Build size increases by >50 kB in one iteration

**Causes**:
- New dependency added
- Large asset bundled (images, fonts)
- Duplicate code not tree-shaken
- Debug code not removed

**Actions**:
1. Run `npm run audit:size` to see size breakdown
2. Check `git diff` for new imports
3. Review recent commits for large file additions
4. Use bundle analyzer to identify culprits

### Gradual Bloat
**Symptoms**: Build size grows 5-10 kB per iteration over multiple iterations

**Causes**:
- Accumulating helper functions
- Growing constants/configuration
- Increasing test fixtures (if bundled)
- More complex logic

**Actions**:
1. Review recent additions for redundancy
2. Consider extracting shared utilities
3. Verify tests aren't bundled (they shouldn't be)
4. Profile code for optimization opportunities

## Integration with CI

**Current**: CI builds but doesn't enforce size limits

**Recommended Addition**:
```yaml
# .github/workflows/ci.yml
- name: Check bundle size
  run: |
    npm run build
    SIZE=$(npm run build 2>&1 | grep "index.*\.js" | awk '{print $3}' | sed 's/kB//')
    if (( $(echo "$SIZE > 1200" | bc -l) )); then
      echo "‚ö†Ô∏è Warning: Bundle size $SIZE kB exceeds 1,200 kB threshold"
      exit 1
    fi
```

## References

- Vite documentation: https://vitejs.dev/guide/build.html
- Rollup tree-shaking: https://rollupjs.org/guide/en/#tree-shaking
- package.json `sideEffects` field (line 58)
- npm audit:size script (package.json line 34)

---

**Last Updated**: 2025-11-05 (Iteration 61)
**Next Review**: When bundle size increases or after major dependency updates
**Baseline Established**: Iteration 61 (1,143.27 kB JS, stable since Iteration 26)
