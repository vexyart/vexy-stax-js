# <!-- this_file: .troubleshooting.md -->
# Troubleshooting Guide

## Overview

Common issues and solutions for Vexy Stax JS development. Check this guide before opening GitHub issues.

---

## Quick Diagnostics

### Health Check Commands

```bash
# Verify Node.js version (must be 18+)
node --version

# Check for outdated dependencies
npm outdated

# Run security audit
npm audit

# Run all tests
npm test

# Check test coverage
npm run test:coverage

# Verify build succeeds
npm run build

# Check bundle size
npm run audit:size
```

---

## Installation Issues

### Error: `npm ci` Fails

**Symptoms**:
```
npm ERR! The `npm ci` command can only install with an existing package-lock.json
```

**Cause**: Missing or corrupted `package-lock.json`

**Fix**:
```bash
# Regenerate lock file
rm package-lock.json
npm install

# Commit updated lock file
git add package-lock.json
git commit -m "Regenerate package-lock.json"
```

---

### Error: Node.js Version Mismatch

**Symptoms**:
```
Error: Node.js 18+ required
```

**Cause**: Using Node.js < 18

**Fix**:
```bash
# Install nvm (if not installed)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# Use correct version from .nvmrc
nvm install
nvm use

# Verify
node --version  # Should show v18.x.x or higher
```

---

### Error: `EACCES` Permission Denied

**Symptoms**:
```
npm ERR! code EACCES
npm ERR! syscall access
```

**Cause**: npm trying to write to system directories

**Fix**:
```bash
# Option 1: Use correct npm prefix (recommended)
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# Option 2: Fix permissions (less safe)
sudo chown -R $(whoami) ~/.npm
```

---

## Test Failures

### Error: Tests Pass Locally But Fail in CI

**Symptoms**: Green locally, red in GitHub Actions

**Possible Causes**:
1. **Environment differences** (Node.js version, OS)
2. **Timing issues** (CI slower than local)
3. **Missing files** (.gitignore hiding required files)

**Fix**:
```bash
# Match CI environment
nvm use 18
npm ci  # Not npm install

# Run tests without cache
rm -rf node_modules
npm ci
npm test

# Check for ignored files affecting tests
git status --ignored
```

---

### Error: Flaky Test Failures

**Symptoms**: Test fails intermittently

**Cause**: Timing dependencies without safety margins

**Example Bad Test**:
```javascript
it('updates after delay', async () => {
  setTimeout(() => state.update(), 50);
  await new Promise(resolve => setTimeout(resolve, 50)); // FLAKY: Exact timing
  assert.ok(state.isUpdated);
});
```

**Fix**:
```javascript
it('updates after delay', async () => {
  setTimeout(() => state.update(), 50);
  await new Promise(resolve => setTimeout(resolve, 100)); // STABLE: 2x safety margin
  assert.ok(state.isUpdated);
});
```

**Prevention**:
- Use 2x-3x timeouts (50ms delay → 100ms test)
- Avoid testing exact timing
- Use mocks for time-dependent code

---

### Error: Coverage Drops Unexpectedly

**Symptoms**:
```
Error: Coverage thresholds not met (79% < 80%)
```

**Cause**: New untested code or code moved from tested module

**Fix**:
```bash
# Generate HTML coverage report
npm run test:coverage
open coverage/index.html

# Find uncovered lines (red highlighting)
# Add tests for uncovered code

# Verify coverage improved
npm run test:coverage:check
```

---

### Error: Import Statement Fails in Tests

**Symptoms**:
```
Error: Cannot use import statement outside a module
```

**Cause**: Missing `"type": "module"` in package.json

**Fix**: Verify package.json has:
```json
{
  "type": "module"
}
```

**Alternative**: Use `.mjs` file extension for test files

---

## Build Issues

### Error: Vite Build Fails

**Symptoms**:
```
[vite]: Rollup failed to resolve import
```

**Cause**: Missing dependency or incorrect import path

**Fix**:
```bash
# Check dependency is installed
npm list <package-name>

# If missing, install it
npm install <package-name>

# Verify import path is correct
# Use: import { foo } from './path/to/module.js'
# Not: import { foo } from './path/to/module'  # Missing .js
```

---

### Error: Bundle Size Exceeds Limit

**Symptoms**: Build succeeds but bundle > 1,300 kB

**Cause**: Large dependency added or inefficient imports

**Fix**:
```bash
# Analyze bundle composition
npm run audit:size

# Check for unnecessary imports
npx vite-bundle-visualizer

# Remove unused dependencies
npm uninstall <unused-package>

# Use tree-shakeable imports
# Good: import { func } from 'lib'
# Bad:  import * as lib from 'lib'
```

---

### Error: Missing `docs/` Folder After Build

**Symptoms**: Build runs but no output in `docs/`

**Cause**: Vite output directory misconfigured

**Fix**: Verify `vite.config.js`:
```javascript
export default defineConfig({
  build: {
    outDir: 'docs',  // Must be 'docs' for GitHub Pages
  }
});
```

---

## Runtime Errors

### Error: WebGL Context Lost

**Symptoms**: Three.js scene turns black, console shows "WebGL context lost"

**Cause**: GPU driver crash or too many textures

**Automatic Recovery**: Already implemented in SceneManager.js (lines 249-292)

**Manual Recovery**:
```javascript
// In browser console
vexyStax.clearAll()  // Clear all images
location.reload()    // Reload page
```

**Prevention**:
- Limit image count (warns at 500MB, blocks at 1000MB)
- Use power-of-2 texture sizes
- Dispose unused textures

---

### Error: Memory Warning (500MB)

**Symptoms**: Toast notification "Memory usage: 520MB (Warning threshold: 500MB)"

**Cause**: Too many high-resolution images loaded

**Fix**:
1. **Delete unused images**: Click ❌ on thumbnails
2. **Optimize image sizes**: Use 2048x2048 max, not 8192x8192
3. **Reduce image count**: Load <10 images at once

**Check Memory**:
```javascript
vexyStax.getStats()  // Shows memory usage, FPS, image count
```

---

### Error: Low FPS (< 30 FPS)

**Symptoms**: Sluggish camera controls, animations stutter

**Causes**:
1. **Too many images** (>10 high-res images)
2. **High-DPI display** (Retina/4K)
3. **Weak GPU**

**Fixes**:
```javascript
// Reduce image count
vexyStax.clearAll()

// Disable shadows (in browser console)
// Note: Requires custom code modification

// Lower resolution images
// Resize images to 1024x1024 before loading

// Check FPS
vexyStax.showFPS(true)
```

**Performance Targets**:
- **Desktop** (dedicated GPU): 60 FPS with 10 images
- **Laptop** (integrated GPU): 30-45 FPS with 10 images
- **Warning threshold**: < 30 FPS

---

### Error: Image Won't Load

**Symptoms**: Upload succeeds but image doesn't appear

**Possible Causes**:

#### 1. Unsupported File Type
```javascript
// Supported: PNG, JPG, JPEG, GIF, WebP, SVG
// Unsupported: TIFF, BMP, HEIC
```

**Fix**: Convert to PNG/JPG before uploading

#### 2. File Too Large (>50MB)
**Fix**: Reduce file size or split into smaller images

#### 3. Corrupted Image File
**Fix**: Re-export from source application

#### 4. Browser Limitations
**Fix**: Try different browser (Chrome 90+, Firefox 88+, Safari 14+)

---

## Git/Deployment Issues

### Error: Git Push Rejected

**Symptoms**:
```
! [rejected] main -> main (non-fast-forward)
```

**Cause**: Local branch behind remote

**Fix**:
```bash
# Pull latest changes
git pull origin main --rebase

# Resolve conflicts (if any)
git rebase --continue

# Push again
git push origin main
```

---

### Error: GitHub Actions CI Fails

**Symptoms**: Red X on commit, "Some checks were not successful"

**Diagnosis**:
1. Click red X to see failing check
2. Click "Details" to view logs
3. Identify failing step

**Common Failures**:

#### Tests Failed
```bash
# Run tests locally
npm test

# Fix failing tests
# Commit and push
```

#### Security Audit Failed
```bash
# Check vulnerabilities
npm audit

# Update vulnerable packages
npm audit fix

# Commit updated package-lock.json
git add package-lock.json
git commit -m "Security: Fix vulnerabilities"
git push
```

#### Build Failed
```bash
# Run build locally
npm run build

# Check for errors
# Fix and push
```

---

### Error: GitHub Pages Not Updating

**Symptoms**: Pushed v0.2.0 tag but site still shows v0.1.0

**Diagnosis**:
1. Check Actions tab: https://github.com/vexyart/vexy-stax-js/actions
2. Find "Deploy to Github Pages" workflow
3. Check if workflow ran successfully

**Possible Causes**:

#### 1. Tag Not Pushed
```bash
# Push tag
git push origin v0.2.0
```

#### 2. Workflow Failed
- Check workflow logs for errors
- Fix errors in code
- Delete and re-create tag:
```bash
git tag -d v0.2.0
git push origin :refs/tags/v0.2.0
git tag -a v0.2.0 -m "Release v0.2.0"
git push origin v0.2.0
```

#### 3. GitHub Pages Cache
- Wait 5-10 minutes for propagation
- Hard refresh browser: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)
- Clear browser cache

---

## Editor/IDE Issues

### VSCode: Import Autocomplete Not Working

**Symptoms**: No IntelliSense for project modules

**Cause**: Missing jsconfig.json or misconfigured

**Fix**: Create `jsconfig.json`:
```json
{
  "compilerOptions": {
    "module": "esnext",
    "target": "esnext",
    "moduleResolution": "node"
  },
  "include": ["src/**/*", "tests/**/*"]
}
```

---

### VSCode: ESLint Not Working

**Symptoms**: No linting errors shown

**Note**: This project doesn't use ESLint (uses .editorconfig for formatting)

**Alternative**: Use Prettier for code formatting:
```bash
npm install --save-dev prettier
echo "node_modules/" > .prettierignore
npx prettier --write "src/**/*.js"
```

---

### Line Endings Wrong (CRLF vs LF)

**Symptoms**: Git shows all files modified after checkout

**Cause**: Windows using CRLF, project uses LF

**Fix**: Verify `.gitattributes` exists:
```gitattributes
* text=auto eol=lf
*.js text eol=lf
*.json text eol=lf
```

**Convert Existing Files**:
```bash
# Install dos2unix (if needed)
brew install dos2unix  # macOS
sudo apt install dos2unix  # Linux

# Convert files
find . -name "*.js" -type f -exec dos2unix {} \;
```

---

## Performance Issues

### Slow Test Suite (>800ms)

**Symptoms**: Tests take >800ms (baseline: 627ms)

**Diagnosis**:
```bash
# Run tests multiple times
for i in {1..5}; do npm run test:unit 2>&1 | grep "duration_ms"; done
```

**Possible Causes**:

#### 1. New Slow Test Added
**Fix**: Optimize test or use mocks

#### 2. Machine Performance
**Fix**: Close other applications, restart Node.js

#### 3. Test Suite Bloat
**Fix**: Review test count, remove redundant tests

---

### Slow Build (>5 minutes)

**Symptoms**: `npm run build` takes >5 minutes

**Diagnosis**:
```bash
# Time the build
time npm run build
```

**Possible Causes**:

#### 1. Large Dependencies
```bash
# Analyze bundle size
npm run audit:size
npx vite-bundle-visualizer
```

#### 2. No Build Cache
```bash
# Clear and rebuild
rm -rf node_modules/.vite
npm run build
```

#### 3. Resource Intensive
**Fix**: Close other applications, ensure sufficient RAM (>8GB)

---

## Browser Console Errors

### Error: `Failed to load resource: net::ERR_FILE_NOT_FOUND`

**Symptoms**: Missing asset files (JS/CSS/images)

**Cause**: Incorrect base path in Vite config

**Fix**: For GitHub Pages, verify `vite.config.js`:
```javascript
export default defineConfig({
  base: '/vexy-stax-js/',  // Must match repo name
});
```

---

### Error: `THREE.WebGLRenderer: WebGL2 not available`

**Symptoms**: Console warning about WebGL

**Impact**: Falls back to WebGL 1 (still functional)

**Fix**: Update browser to latest version (Chrome 90+, Firefox 88+, Safari 14+)

---

### Error: `ReferenceError: vexyStax is not defined`

**Symptoms**: Console error when calling `vexyStax.exportPNG()`

**Cause**: Calling API before page fully loaded

**Fix**: Wait for page load:
```javascript
window.addEventListener('load', () => {
  vexyStax.exportPNG(2);
});
```

---

## Dependency Issues

### Error: `npm audit` Shows Vulnerabilities

**Symptoms**:
```
found 3 vulnerabilities (1 moderate, 2 high)
```

**Triage**:
```bash
# Check details
npm audit

# Check if fix available
npm audit fix --dry-run

# Apply fixes
npm audit fix
```

**If No Fix Available**:
1. Check if vulnerability affects production code
2. If dev dependency: Usually safe to ignore (or update major version)
3. If production: Find alternative package or wait for maintainer fix

---

### Error: `npm outdated` Shows Many Updates

**Symptoms**: Many packages have newer versions

**Strategy**:
```bash
# Update patch versions only (safe)
npm update

# Update specific package to latest
npm install three@latest

# Test thoroughly after updates
npm test
npm run build
```

**When to Update**:
- **Patch** (0.0.X): Safe, do monthly
- **Minor** (0.X.0): Test, do quarterly
- **Major** (X.0.0): Full regression testing, plan separately

---

## Getting More Help

### Collect Diagnostic Information

Before opening GitHub issue, run:

```bash
# System info
node --version
npm --version
git --version

# Package versions
npm list --depth=0

# Test results
npm test

# Build results
npm run build

# Check for uncommitted changes
git status

# Recent commits
git log --oneline -5
```

### Open GitHub Issue

**Template**:
```markdown
## Description
[Clear description of the problem]

## Steps to Reproduce
1. Run `npm install`
2. Run `npm test`
3. See error: [paste error]

## Expected Behavior
[What should happen]

## Actual Behavior
[What actually happens]

## Environment
- Node.js: v18.19.0
- npm: v10.2.3
- OS: macOS 14.1
- Browser: Chrome 120

## Diagnostic Output
```
[paste output from diagnostic commands]
```

## Additional Context
[Any other relevant information]
```

### Resources

- **GitHub Issues**: https://github.com/vexyart/vexy-stax-js/issues
- **GitHub Discussions**: https://github.com/vexyart/vexy-stax-js/discussions
- **Documentation**: README.md, CONTRIBUTING.md, API.md
- **Testing Guide**: `.testing-guide.md`
- **CI/CD Guide**: `.cicd-workflow.md`

---

**Last Updated**: 2025-11-05 (Iteration 63)
**Covers**: Installation, testing, builds, runtime, deployment, editor issues
**Maintainer**: Project maintainer
