# <!-- this_file: .cicd-workflow.md -->
# CI/CD Workflow Documentation

## Overview

Vexy Stax JS uses GitHub Actions for automated testing, building, and deployment. This document explains the CI/CD pipeline, triggers, and deployment process.

---

## Continuous Integration (CI)

### Workflow File
**Location**: `.github/workflows/ci.yml`
**Purpose**: Automated testing and validation on every push/PR

### Trigger Conditions

```yaml
on:
  push:
    branches: [main]      # Every push to main branch
  pull_request:
    branches: [main]      # Every PR targeting main
```

**When It Runs**:
- Commits pushed to `main` branch
- Pull requests opened/updated targeting `main`
- Re-runs available via GitHub UI

---

## CI Pipeline Steps

### Step 1: Checkout Code
```yaml
- uses: actions/checkout@v4
```
**Purpose**: Clone repository to runner
**Version**: v4 (latest stable)

### Step 2: Setup Node.js
```yaml
- uses: actions/setup-node@v4
  with:
    node-version-file: '.nvmrc'    # Uses .nvmrc for version
    cache: 'npm'                    # Caches node_modules
```
**Purpose**: Install Node.js from `.nvmrc` (18+)
**Caching**: Speeds up dependency installation

### Step 3: Verify Node.js Version
```bash
node --version | grep -E "^v(1[89]|[2-9][0-9])\."
```
**Purpose**: Enforce Node.js 18+ requirement
**Failure**: Exits with error if Node.js < 18

### Step 4: Install Dependencies
```bash
npm ci
```
**Purpose**: Install dependencies from `package-lock.json`
**Why `npm ci`**: Faster, deterministic installs (vs `npm install`)

### Step 5: Verify Package Lock
```bash
git diff --exit-code package-lock.json
```
**Purpose**: Detect uncommitted lockfile changes
**Failure**: Indicates outdated lock (prevents "works on my machine")

### Step 6: Security Audit
```bash
npm audit --audit-level=high
```
**Purpose**: Check for high/critical vulnerabilities
**Threshold**: Fails only on high/critical (not low/moderate)
**Current Status**: 0 vulnerabilities ✅

### Step 7: Run Tests
```bash
npm run test:unit
```
**Purpose**: Execute all 223 unit tests
**Baseline**: 627ms ±3ms
**Coverage**: 96.41% core, 100% utils

### Step 8: Build
```bash
npm run build
```
**Purpose**: Vite build to `docs/` folder
**Output**: 1,143.27 kB bundle (stable)

### Step 9: Upload Build Artifacts
```yaml
- uses: actions/upload-artifact@v4
  with:
    name: docs
    path: docs/
```
**Purpose**: Archive build for debugging
**Retention**: 90 days (GitHub default)

---

## CI Performance

### Typical Runtime
- **Total Duration**: 2-3 minutes
- **Fastest Step**: Checkout (~5s)
- **Slowest Step**: npm ci (~45s on cache miss)

### Caching Strategy
- **node_modules** cached via `actions/setup-node@v4`
- **Cache key**: `package-lock.json` hash
- **Cache hit**: ~15s install time
- **Cache miss**: ~45s install time

---

## Continuous Deployment (CD)

### Workflow File
**Location**: `.github/workflows/deploy.yml`
**Purpose**: Deploy to GitHub Pages on version tags

### Trigger Conditions

```yaml
on:
  push:
    tags:
      - 'v*'              # Any tag starting with 'v'
  workflow_dispatch:      # Manual trigger via GitHub UI
```

**When It Runs**:
- Git tag pushed matching `v*` pattern (e.g., `v0.2.0`)
- Manually triggered via GitHub Actions UI

---

## Deployment Pipeline Steps

### Step 1: Checkout Code (with history)
```yaml
- uses: actions/checkout@v4
  with:
    fetch-depth: 0        # Full history (for git tags)
```
**Purpose**: Clone repository with all commits/tags

### Step 2: Setup Node.js
```yaml
- uses: actions/setup-node@v4
  with:
    node-version: '20'    # Fixed version for consistency
    cache: 'npm'
```
**Purpose**: Install Node.js 20 (LTS)

### Step 3: Extract Version from Tag
```bash
VERSION=${GITHUB_REF#refs/tags/v}
```
**Purpose**: Parse version from tag (e.g., `v0.2.0` → `0.2.0`)
**Fallback**: `dev` if not a tag push

### Step 4: Update package.json Version
```bash
npm version $VERSION --no-git-tag-version
```
**Purpose**: Sync package.json version with git tag
**Skip**: If manually triggered (version=dev)

### Step 5: Install Dependencies
```bash
npm ci
```
**Purpose**: Fresh, deterministic install

### Step 6: Build
```bash
npm run build
```
**Purpose**: Vite build to `docs/` folder
**Output**: index.html, assets/index-{hash}.js, assets/index-{hash}.css

### Step 7: Upload Pages Artifact
```yaml
- uses: actions/upload-pages-artifact@v3
  with:
    path: docs/
```
**Purpose**: Prepare artifact for GitHub Pages deployment

### Step 8: Deploy to GitHub Pages
```yaml
- uses: actions/deploy-pages@v4
```
**Purpose**: Publish `docs/` folder to GitHub Pages
**URL**: https://vexyart.github.io/vexy-stax-js/
**Environment**: `github-pages` (automatic)

---

## Deployment Process

### Step-by-Step Release

#### 1. Prepare Release
```bash
# Ensure all changes committed
git status

# Ensure tests pass locally
npm test

# Ensure build succeeds
npm run build
```

#### 2. Update Version in package.json
```bash
# Example: 0.1.0 → 0.2.0
npm version 0.2.0 --no-git-tag-version

# Commit version bump
git add package.json
git commit -m "Release v0.2.0"
```

#### 3. Create Annotated Git Tag
```bash
git tag -a v0.2.0 -m "Release v0.2.0

Highlights:
- 223 tests passing (+113 from v0.1.0)
- 96%+ test coverage on core modules
- Complete documentation (BROWSER_COMPATIBILITY, PERFORMANCE, testing guide)
- Zero security vulnerabilities

See CHANGELOG.md for full details."
```

#### 4. Push to GitHub
```bash
# Push commits and tag
git push origin main --tags
```

#### 5. Monitor Deployment
- Navigate to: https://github.com/vexyart/vexy-stax-js/actions
- Watch "Deploy to Github Pages" workflow
- Verify green checkmarks for all steps
- Click "github-pages" environment URL to verify deployment

#### 6. Verify Live Site
```bash
# Open in browser
open https://vexyart.github.io/vexy-stax-js/
```

**Verification Checklist**:
- [ ] Page loads without errors
- [ ] All assets loaded (check DevTools Network tab)
- [ ] Three.js scene renders
- [ ] Tweakpane controls functional
- [ ] Image upload works
- [ ] Export functions work

---

## Manual Deployment

### Via GitHub UI

1. Go to: https://github.com/vexyart/vexy-stax-js/actions
2. Select "Deploy to Github Pages" workflow
3. Click "Run workflow" dropdown
4. Select `main` branch
5. Click "Run workflow" button

**Use Cases**:
- Testing deployment process
- Deploying without version tag
- Redeploying after GitHub Pages issue

---

## Deployment Rollback

### Scenario: Bad deployment to GitHub Pages

**Option 1: Revert Commit**
```bash
# Find bad commit
git log --oneline

# Revert it
git revert <commit-sha>

# Push revert
git push origin main
```

**Option 2: Deploy Previous Tag**
```bash
# Delete bad tag (if exists)
git tag -d v0.2.1
git push origin :refs/tags/v0.2.1

# Re-push previous good tag to trigger deploy
git push origin v0.2.0 --force
```

**Option 3: Manual Trigger**
- Use GitHub Actions UI to manually deploy from previous commit
- Select "Deploy to Github Pages" workflow
- Run from specific commit SHA

---

## Environment Variables

### Secrets (None Currently)

No secrets required for current CI/CD pipeline.

**Future Consideration**:
- `NPM_TOKEN` (if publishing to npm registry)
- `SENTRY_DSN` (if adding error tracking)

### GitHub-Provided Variables

Available in workflows:
- `GITHUB_REF`: Branch/tag ref (e.g., `refs/tags/v0.2.0`)
- `GITHUB_SHA`: Commit SHA
- `GITHUB_ACTOR`: User who triggered workflow
- `GITHUB_REPOSITORY`: `vexyart/vexy-stax-js`

---

## Permissions

### CI Workflow (`.github/workflows/ci.yml`)
**Permissions**: Default (read repository)
**No Writes**: Cannot modify code, tags, or releases

### Deploy Workflow (`.github/workflows/deploy.yml`)
**Permissions**:
```yaml
contents: read       # Read repository
pages: write         # Write to GitHub Pages
id-token: write      # OIDC token for deployment
```

---

## Concurrency Control

### Deploy Workflow
```yaml
concurrency:
  group: pages
  cancel-in-progress: false   # Don't cancel in-progress deploys
```

**Purpose**: Only one GitHub Pages deployment at a time
**Behavior**: Queues subsequent deployments

---

## Notifications

### Slack (Not Currently Configured)

Future enhancement could add:
```yaml
- name: Notify Slack on failure
  if: failure()
  run: |
    curl -X POST $SLACK_WEBHOOK \
      -d '{"text":"CI failed for ${{ github.ref }}"}'
```

### GitHub Notifications

Automatic via GitHub:
- Email to committer on workflow failure
- PR status checks (green checkmark / red X)
- GitHub UI badges on Actions tab

---

## Troubleshooting

### CI Failures

#### Tests Fail in CI But Pass Locally
**Cause**: Environment differences
**Fix**:
```bash
# Match CI Node.js version
nvm use 18

# Use exact dependencies
npm ci

# Run tests
npm test
```

#### Security Audit Fails
**Cause**: New vulnerability detected
**Fix**:
```bash
# Check vulnerabilities
npm audit

# Attempt automatic fix
npm audit fix

# If no fix available, update manually
npm update <vulnerable-package>
```

#### Build Size Exceeds Threshold
**Cause**: Bundle grew too large
**Fix**: Check `.filesize-tracking.md` for thresholds, optimize bundle

---

### Deployment Failures

#### GitHub Pages Build Failed
**Cause**: Invalid HTML or missing assets
**Fix**:
1. Download artifacts from failed workflow
2. Inspect `docs/` folder locally
3. Verify all assets present and properly linked

#### Version Mismatch
**Cause**: package.json version doesn't match git tag
**Fix**:
```bash
# Manually sync version
npm version 0.2.0 --no-git-tag-version
git add package.json
git commit --amend --no-edit

# Force push tag
git push origin v0.2.0 --force
```

---

## Monitoring

### Build Status Badge

Add to README.md:
```markdown
[![CI Status](https://github.com/vexyart/vexy-stax-js/actions/workflows/ci.yml/badge.svg)](https://github.com/vexyart/vexy-stax-js/actions/workflows/ci.yml)
```

### Deployment Status

Monitor via:
- **Actions Tab**: https://github.com/vexyart/vexy-stax-js/actions
- **Environments Tab**: https://github.com/vexyart/vexy-stax-js/deployments
- **GitHub Pages Settings**: Repository → Settings → Pages

---

## Performance Optimization

### Caching Strategy

**Current**:
- ✅ node_modules cached via `actions/setup-node@v4`

**Future Optimizations**:
- Cache Vite build cache (`.vite/` folder)
- Cache test results (for incremental testing)
- Parallelize test execution

### Build Time Reduction

**Current**: ~2-3 minutes total
**Target**: <2 minutes

**Opportunities**:
1. Use `pnpm` instead of `npm` (faster installs)
2. Skip build artifacts upload (unless needed)
3. Use matrix strategy for parallel test runs

---

## Workflow Files Location

```
.github/
└── workflows/
    ├── ci.yml          # Continuous Integration
    └── deploy.yml      # GitHub Pages Deployment
```

**Total Workflows**: 2
**Maintenance**: Review quarterly for action version updates

---

## Resources

- **GitHub Actions Docs**: https://docs.github.com/en/actions
- **GitHub Pages Docs**: https://docs.github.com/en/pages
- **Vite Build Docs**: https://vite.dev/guide/build.html
- **npm ci Docs**: https://docs.npmjs.com/cli/v9/commands/npm-ci

---

## Workflow Diagram

```
┌─────────────────────────────────────────────────┐
│  Developer Pushes to main / Creates PR          │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  CI Workflow (.github/workflows/ci.yml)         │
├─────────────────────────────────────────────────┤
│  1. Checkout code                               │
│  2. Setup Node.js 18+ (from .nvmrc)             │
│  3. Verify Node.js version                      │
│  4. npm ci (install dependencies)               │
│  5. Verify package-lock.json unchanged          │
│  6. npm audit --audit-level=high                │
│  7. npm run test:unit (223 tests)               │
│  8. npm run build (Vite → docs/)                │
│  9. Upload build artifacts                      │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
          ✅ All checks pass
          ❌ Fix and push again

┌─────────────────────────────────────────────────┐
│  Developer Creates Git Tag (v0.2.0)             │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  Deploy Workflow (.github/workflows/deploy.yml) │
├─────────────────────────────────────────────────┤
│  1. Checkout code (full history)                │
│  2. Setup Node.js 20                            │
│  3. Extract version from tag                    │
│  4. Update package.json version                 │
│  5. npm ci                                      │
│  6. npm run build                               │
│  7. Upload Pages artifact                       │
│  8. Deploy to GitHub Pages                      │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
  https://vexyart.github.io/vexy-stax-js/
```

---

**Last Updated**: 2025-11-05 (Iteration 63)
**CI Status**: ✅ All workflows passing
**Deployment**: Automated via GitHub Actions
**Manual Override**: Available via workflow_dispatch
