# <!-- this_file: .architecture-diagram.md -->
# Vexy Stax JS - Architecture Diagrams

Visual documentation of system architecture, module relationships, and data flow.

**Last Updated**: 2025-11-05
**Version**: v0.2.0
**Iteration**: 67

---

## ðŸ“ System Overview

### High-Level Architecture

```mermaid
graph TB
    User[User Input] --> UI[Tweakpane UI]
    User --> KB[Keyboard Shortcuts]
    User --> File[File Upload]

    UI --> Main[main.js Entry Point]
    KB --> Main
    File --> Main

    Main --> Core[Core Modules]
    Main --> Managers[Scene Managers]
    Main --> Utils[Utilities]

    Core --> |State| AppState[AppState]
    Core --> |Events| EventBus[EventBus]
    Core --> |Animation| RenderLoop[RenderLoop]
    Core --> |Config| Constants[Constants]

    Managers --> |3D Scene| SceneManager[SceneManager]
    Managers --> |Lighting| LightingManager[LightingManager]
    Managers --> |Floor| FloorManager[FloorManager]

    Utils --> |Math/Validation| Helpers[Helpers]
    Utils --> |Logging| Logger[Logger]
    Utils --> |Camera| CameraAnimator[CameraAnimator]

    SceneManager --> Three[Three.js WebGL]
    LightingManager --> Three
    FloorManager --> Three
    RenderLoop --> Three

    Three --> Canvas[HTML Canvas]
    Canvas --> User

    Main --> Export[Export Functions]
    Export --> |PNG| Browser[Browser Download]
    Export --> |JSON| Browser
    Export --> |Clipboard| Browser
```

**Key Components**:
- **main.js**: 3,367-line entry point orchestrating all modules
- **Core Modules**: State management, event system, animation loop, configuration
- **Scene Managers**: Three.js scene, lighting, floor rendering
- **Utilities**: Math helpers, logging, camera animations
- **UI Layer**: Tweakpane controls + keyboard shortcuts

---

## ðŸ”Œ Module Dependencies

### Dependency Graph

```mermaid
graph LR
    Main[main.js] --> SceneManager
    Main --> LightingManager
    Main --> FloorManager
    Main --> CameraAnimator
    Main --> RenderLoop
    Main --> AppState
    Main --> EventBus
    Main --> Constants
    Main --> Helpers
    Main --> Logger

    SceneManager --> Constants
    SceneManager --> Logger

    LightingManager --> Constants
    LightingManager --> Helpers
    LightingManager --> Logger

    FloorManager --> Constants
    FloorManager --> Logger

    CameraAnimator --> Logger

    RenderLoop --> Logger

    AppState --> Helpers
    EventBus -.-> Logger

    style Main fill:#ff9999
    style Constants fill:#99ff99
    style Logger fill:#9999ff
```

**Dependency Levels**:
- **Level 0** (No dependencies): Constants, Logger, Helpers, EventBus
- **Level 1** (Core utilities): AppState, RenderLoop, CameraAnimator
- **Level 2** (Scene components): SceneManager, LightingManager, FloorManager
- **Level 3** (Application): main.js

**Import Strategy**: Bottom-up (utilities â†’ managers â†’ application)

---

## ðŸ”„ Data Flow Architecture

### State Management Flow

```mermaid
sequenceDiagram
    participant User
    participant UI as Tweakpane UI
    participant Main as main.js
    participant AppState as AppState
    participant EventBus as EventBus
    participant Manager as Scene Manager
    participant Three as Three.js

    User->>UI: Adjust slider
    UI->>Main: onChange callback
    Main->>AppState: set('zSpacing', 100)
    AppState->>AppState: Store value
    AppState->>EventBus: emit('state:changed')
    EventBus->>Manager: Notify listeners
    Manager->>Three: Update scene
    Three->>User: Render updated view
```

**State Flow Characteristics**:
- **Centralized**: All state in AppState singleton
- **Event-driven**: Changes broadcast via EventBus
- **Reactive**: UI updates trigger cascade of scene updates
- **Unidirectional**: User â†’ UI â†’ State â†’ Managers â†’ Render

---

### Image Loading Flow

```mermaid
sequenceDiagram
    participant User
    participant File as File Input
    participant Main as main.js
    participant Validation as validateImageFile
    participant Three as Three.js TextureLoader
    participant SceneManager as SceneManager
    participant Canvas

    User->>File: Drop/Select image
    File->>Main: File object
    Main->>Validation: Check MIME type
    Validation-->>Main: Valid/Invalid

    alt Invalid file
        Main->>User: Show error toast
    else Valid file
        Main->>Three: Load texture
        Three->>Three: Create WebGL texture
        Three-->>Main: Texture object
        Main->>SceneManager: Create mesh
        SceneManager->>SceneManager: Position in stack
        SceneManager->>Canvas: Render
        Canvas->>User: Display updated scene
    end
```

**Loading Characteristics**:
- **Validation first**: MIME type + size checks before loading
- **Retry logic**: 3 attempts with exponential backoff (100ms, 200ms, 400ms)
- **Memory monitoring**: Warns at 500MB, blocks at 1000MB
- **Stack positioning**: Z-position based on index Ã— zSpacing

---

## ðŸ§± Core Module Architecture

### Core Utilities

```mermaid
classDiagram
    class AppState {
        -initialState: Object
        -state: Map
        +get(key: string): any
        +set(key: string, value: any): void
        +mergeInto(key: string, patch: Object): void
        +pushTo(key: string, item: any): void
        +removeFrom(key: string, predicate: Function): void
        +reset(key?: string): void
        +snapshot(): Object
    }

    class EventBus {
        -listeners: Map
        +on(event: string, handler: Function): Function
        +once(event: string, handler: Function): Function
        +off(event: string, handler?: Function): void
        +emit(event: string, ...args: any[]): void
        +clear(): void
    }

    class RenderLoop {
        -renderCallback: Function
        -animationId: number
        -isRunning: boolean
        -showFPSEnabled: boolean
        +setRenderCallback(fn: Function): void
        +start(): void
        +stop(): void
        +showFPS(enabled: boolean): void
        +getFPSStats(): Object
        +dispose(): void
    }

    AppState --> Helpers : uses deepClone
    RenderLoop --> Logger : logs debug info
```

**Design Patterns**:
- **Singleton**: AppState, EventBus, RenderLoop (single instances)
- **Observer**: EventBus pub/sub for decoupled communication
- **Memento**: AppState snapshot/reset for undo/redo
- **Command**: RenderLoop callback pattern for render control

---

### Scene Management

```mermaid
classDiagram
    class SceneManager {
        -scene: THREE.Scene
        -renderer: THREE.WebGLRenderer
        -camera: THREE.PerspectiveCamera
        -canvas: HTMLCanvasElement
        +init(canvas, params, canvasSize): void
        +getScene(): THREE.Scene
        +getRenderer(): THREE.WebGLRenderer
        +getCamera(): THREE.Camera
        +setBackground(color: string, alpha: number): void
        +dispose(): void
    }

    class LightingManager {
        -scene: THREE.Scene
        -lights: Array
        +setup(scene, params): void
        +updateFromBackground(bgColor, ambientMode): void
        +dispose(): void
    }

    class FloorManager {
        -scene: THREE.Scene
        -floor: THREE.Mesh
        +create(scene, params): void
        +updateColor(color: string, alpha: number): void
        +setVisible(visible: boolean): void
        +dispose(): void
    }

    SceneManager --> THREE : manages scene
    LightingManager --> THREE : manages lights
    FloorManager --> THREE : manages floor mesh

    LightingManager --> Helpers : uses calculateLuminance
    FloorManager --> Helpers : uses getAdaptiveFloorColor
```

**Lifecycle**:
1. **Init**: SceneManager creates scene, renderer, camera
2. **Setup**: LightingManager adds lights, FloorManager creates floor
3. **Update**: Managers respond to state changes via EventBus
4. **Dispose**: All managers clean up WebGL resources

---

## ðŸŽ¨ Rendering Pipeline

### Render Cycle

```mermaid
sequenceDiagram
    participant RAF as requestAnimationFrame
    participant RenderLoop as RenderLoop
    participant Render as Render Callback
    participant Controls as OrbitControls
    participant Three as THREE.Renderer
    participant Canvas
    participant FPS as FPS Monitor

    loop Animation Loop
        RAF->>RenderLoop: Next frame
        RenderLoop->>FPS: Update counters
        RenderLoop->>Render: Call callback
        Render->>Controls: Update camera
        Render->>Three: renderer.render(scene, camera)
        Three->>Canvas: WebGL draw
        Canvas-->>RAF: Frame complete

        alt FPS Enabled
            FPS->>FPS: Calculate avg FPS
            alt Low FPS (<30)
                FPS->>Console: Warn performance
            end
        end
    end
```

**Performance Characteristics**:
- **Target**: 60 FPS (16.67ms per frame)
- **Warning threshold**: <30 FPS
- **Optimization**: OrbitControls.enableDamping for smooth movement
- **Memory**: Context loss recovery handles GPU resets

---

## ðŸ’¾ Export Architecture

### Export Data Flow

```mermaid
graph TB
    User[User Action] --> Export{Export Type?}

    Export -->|PNG| PNG[exportPNG]
    Export -->|JSON| JSON[exportJSON]
    Export -->|Clipboard| Clipboard[copyToClipboard]

    PNG --> Scale{Scale Factor?}
    Scale -->|1x| Render1[Render 1x]
    Scale -->|2x| Render2[Render 2x]
    Scale -->|4x| Render4[Render 4x]

    Render1 --> Canvas1[Resize canvas]
    Render2 --> Canvas2[Resize canvas 2x]
    Render4 --> Canvas4[Resize canvas 4x]

    Canvas1 --> ToBlob[toBlob]
    Canvas2 --> ToBlob
    Canvas4 --> ToBlob

    ToBlob --> Download[Trigger download]

    JSON --> Serialize[Serialize params + images]
    Serialize --> Base64[Convert images to base64]
    Base64 --> JSONString[JSON.stringify]
    JSONString --> JSONDownload[Trigger download]

    Clipboard --> JSONString2[JSON.stringify]
    JSONString2 --> Navigator[navigator.clipboard.writeText]

    Download --> User
    JSONDownload --> User
    Navigator --> User
```

**Export Features**:
- **PNG**: 1x/2x/4x scale, transparent background option
- **JSON**: Complete scene state + base64 image data
- **Clipboard**: JSON copied for paste into code/tools

---

## ðŸ” Security & Validation

### Input Validation Flow

```mermaid
graph TB
    Input[User Input] --> Type{Input Type?}

    Type -->|File| FileVal[File Validation]
    Type -->|Number| NumVal[Number Validation]
    Type -->|Color| ColorVal[Color Validation]
    Type -->|JSON| JSONVal[JSON Validation]

    FileVal --> MIME[Check MIME type]
    MIME --> Size[Check size < 50MB]
    Size --> FileOK{Valid?}

    NumVal --> Finite[Check isFinite]
    Finite --> Range[Check range]
    Range --> NumOK{Valid?}

    ColorVal --> Hex[Validate hex format]
    Hex --> ColorOK{Valid?}

    JSONVal --> Parse[Try JSON.parse]
    Parse --> Structure[Check structure]
    Structure --> JSONOK{Valid?}

    FileOK -->|Yes| Accept[Accept input]
    FileOK -->|No| Reject[Show error]

    NumOK -->|Yes| Accept
    NumOK -->|No| Reject

    ColorOK -->|Yes| Accept
    ColorOK -->|No| Reject

    JSONOK -->|Yes| Accept
    JSONOK -->|No| Reject

    Reject --> User[User sees toast]
    Accept --> Process[Process input]
```

**Validation Strategy**:
- **Type checking**: Reject non-numbers, non-strings early
- **Range checking**: Enforce min/max bounds (zSpacing 0-500, etc.)
- **Size limits**: 50MB per file, 1000MB total memory
- **Format validation**: Hex colors, MIME types, JSON structure

---

## ðŸ§© Plugin Architecture (Future)

### Extensibility Design (Phase 5)

```mermaid
graph TB
    Core[Core System] --> API[Plugin API]

    API --> Hooks[Lifecycle Hooks]
    API --> Events[Event System]
    API --> Registry[Plugin Registry]

    Hooks --> Init[onInit]
    Hooks --> Render[onRender]
    Hooks --> Export[onExport]
    Hooks --> Dispose[onDispose]

    Events --> Sub[Subscribe to events]
    Events --> Pub[Publish custom events]

    Registry --> Load[Load plugins]
    Registry --> Enable[Enable/disable]
    Registry --> Config[Configure]

    Plugin1[Material Plugin] --> API
    Plugin2[Export Plugin] --> API
    Plugin3[Effect Plugin] --> API
```

**Future Plugin Types**:
- **Material plugins**: Custom shaders, procedural textures
- **Export plugins**: MP4/WebM video, GIF animation, 3D formats
- **Effect plugins**: Post-processing, filters, distortions
- **UI plugins**: Custom controls, themes, layouts

---

## ðŸ“Š Performance Monitoring

### Monitoring Architecture

```mermaid
graph TB
    App[Application] --> Monitor[Performance Monitor]

    Monitor --> FPS[FPS Counter]
    Monitor --> Memory[Memory Tracker]
    Monitor --> Timing[Timing API]

    FPS --> Warn{<30 FPS?}
    Warn -->|Yes| Alert[Console warning]
    Warn -->|No| OK[Continue]

    Memory --> Check{>500MB?}
    Check -->|Yes| Warn2[Show warning]
    Check -->|No| OK2[Continue]

    Timing --> Profile[performance.now]
    Profile --> Log[Log slow operations]

    Alert --> Stats[getStats API]
    Warn2 --> Stats
    Log --> Stats

    Stats --> Dev[Developer Console]
```

**Monitoring Features**:
- **FPS**: Real-time average over 1-second window
- **Memory**: Estimated texture memory (width Ã— height Ã— 4 bytes)
- **Timing**: Critical operations logged with duration
- **Warnings**: Automatic alerts for performance issues

---

## ðŸ”— Module Communication

### Event-Driven Communication

```mermaid
graph LR
    subgraph Producers
        UI[UI Controls]
        Keyboard[Keyboard]
        FileInput[File Input]
    end

    subgraph EventBus
        Events[Event Channels]
    end

    subgraph Consumers
        SceneManager[Scene Manager]
        LightingManager[Lighting Manager]
        FloorManager[Floor Manager]
        CameraAnimator[Camera Animator]
    end

    UI -->|state:changed| Events
    Keyboard -->|camera:mode| Events
    FileInput -->|image:loaded| Events

    Events -->|subscribe| SceneManager
    Events -->|subscribe| LightingManager
    Events -->|subscribe| FloorManager
    Events -->|subscribe| CameraAnimator

    style Events fill:#ffeb3b
```

**Event Channels**:
- `state:changed` - AppState updates
- `camera:mode` - Camera mode switches
- `image:loaded` - New image added to stack
- `image:removed` - Image removed from stack
- `material:changed` - Material preset changed

---

## ðŸ“– Related Documentation

- [PLAN.md](PLAN.md) - Strategic planning and module extraction roadmap
- [.project-metrics.md](.project-metrics.md) - Current architecture statistics
- [DEPENDENCIES.md](DEPENDENCIES.md) - External dependencies (Three.js, Tweakpane, GSAP)
- [.testing-guide.md](.testing-guide.md) - Testing architecture and strategies

---

**Architecture Status**: âœ… Modular, testable, extensible

*Diagrams generated with Mermaid - view in GitHub or compatible Markdown viewer*
